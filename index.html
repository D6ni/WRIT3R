<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WRIT3R</title>
    <link rel="icon" type="image/x-icon" href="favicon.png">

    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,300;1,400&family=Roboto:wght@400;500&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Librerías JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Librería para el efecto de pasar página -->
    <script src="https://cdn.jsdelivr.net/npm/page-flip/dist/js/page-flip.browser.js"></script>

    <style>
        /* --- ESTILOS GENERALES Y DEL EDITOR (WRIT3R UI) --- */
        :root {
            --bg-top: #131720;
            --bg-bottom: #020203;
            --glass-bg: rgba(20, 25, 35, 0.6); 
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            --text-main: #c9d1d9; 
            --text-muted: #606775;
            --accent: #64b5f6;
            --accent-hover: rgba(100, 181, 246, 0.15);
            --danger: #ef5350;
            --folder-color: #f0c674;
            --font-ui: 'Roboto', Helvetica, Arial, sans-serif;
            --font-editor: 'Merriweather', serif;
            
            /* Variables Lector */
            --reader-bg: #1a1a1a;
            --reader-page-bg: #fdfbf7;
            --reader-text: #2c2c2c;
            --reader-accent: #e0c070;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.25); }
        ::-webkit-scrollbar-corner { background: transparent; }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0;
            height: 100vh;
            background: linear-gradient(to bottom, var(--bg-top), var(--bg-bottom));
            font-family: var(--font-ui);
            color: var(--text-main);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none; 
        }

        /* Contenedor Principal App */
        .app-container {
            width: 95vw;
            height: 92vh;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: var(--glass-shadow);
            display: grid;
            grid-template-columns: 260px 1fr;
            grid-template-rows: 100%;
            overflow: hidden;
            position: relative;
            transition: grid-template-columns 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 1;
        }

        .app-container.zen-mode { grid-template-columns: 0px 1fr; }
        .app-container.zen-mode aside { opacity: 0; pointer-events: none; padding: 0; }
        .app-container.zen-mode .header-top-row { opacity: 0; pointer-events: none; height: 0; margin: 0; overflow: hidden; }
        .app-container.zen-mode #editor { max-width: 850px; padding-top: 40px; }

        #exit-zen-btn {
            position: absolute; top: 25px; right: 30px;
            background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            color: var(--text-muted); width: 40px; height: 40px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        #exit-zen-btn:hover { color: var(--accent); border-color: var(--accent); background: var(--accent-hover); }
        .app-container.zen-mode #exit-zen-btn { opacity: 1; pointer-events: all; }

        /* Sidebar */
        aside {
            background: rgba(5, 7, 10, 0.4); border-right: 1px solid var(--glass-border);
            display: flex; flex-direction: column; padding: 20px;
            position: relative; height: 100%; overflow: hidden; min-width: 0;
            transition: opacity 0.3s ease;
        }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border); z-index: 2; }
        .sidebar-title { font-weight: 600; letter-spacing: 0.5px; font-size: 0.9rem; color: var(--text-main); display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .sidebar-title:hover { color: var(--accent); }
        .project-name { font-weight: 400; opacity: 0.7; font-size: 0.8rem; margin-left: 5px; }
        .controls { display: flex; gap: 8px; flex-shrink: 0; margin-left: auto; }
        .btn-icon { background: transparent; border: 1px solid var(--glass-border); color: var(--text-muted); border-radius: 4px; cursor: pointer; padding: 4px 8px; transition: 0.2s; }
        .btn-icon:hover { background: var(--glass-border); color: var(--text-main); }
        .file-tree { flex: 1; overflow-y: auto; overflow-x: hidden; min-height: 0; padding-right: 5px; position: relative; padding-bottom: 50px; }
        .tree-item { padding: 8px 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; transition: background 0.1s; font-size: 0.9rem; color: #a0aab5; border: 2px solid transparent; position: relative; white-space: nowrap; }
        .tree-item:hover { background: rgba(255,255,255,0.03); color: var(--text-main); }
        .tree-item.active-file { color: var(--text-main); font-weight: 500; background: rgba(255,255,255,0.05); }
        .tree-item.selected { background: rgba(100, 181, 246, 0.15); border-color: rgba(100, 181, 246, 0.3); color: #fff; }
        .tree-item i { margin-right: 12px; font-size: 0.9rem; }
        .tree-item i.fa-folder, .tree-item i.fa-folder-open { color: var(--folder-color); filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .tree-item i.fa-file-alt { color: var(--accent); opacity: 0.8; }
        .folder-content { margin-left: 18px; padding-left: 5px; border-left: 1px solid rgba(255,255,255,0.05); }
        .dragging { opacity: 0.4; }
        .tree-item.drop-inside { background: rgba(100, 181, 246, 0.2); border: 2px dashed var(--accent); }
        .tree-item.drop-top { border-top: 2px solid var(--accent) !important; border-top-left-radius: 0; border-top-right-radius: 0; }
        .tree-item.drop-bottom { border-bottom: 2px solid var(--accent) !important; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        
        /* Main Editor Area */
        main { display: flex; flex-direction: column; padding: 40px 60px; position: relative; background: transparent; height: 100%; overflow: hidden; }
        .editor-header { margin-bottom: 30px; display: flex; flex-direction: column; gap: 10px; max-width: 720px; width: 100%; margin-left: auto; margin-right: auto; transition: opacity 0.3s; }
        .header-top-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass-border); padding-bottom: 5px; transition: all 0.4s; }
        #doc-title { flex: 1; background: transparent; border: none; color: var(--text-main); font-family: var(--font-ui); font-size: 2.2rem; font-weight: 700; min-width: 0; }
        #doc-title:focus { outline: none; }
        #doc-title::placeholder { color: var(--text-muted); opacity: 0.5; font-weight: 400; }
        .header-actions { display: flex; align-items: center; gap: 8px; }
        .btn-family { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); color: var(--text-muted); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 6px; white-space: nowrap; font-family: var(--font-ui); }
        .btn-family:hover { background: var(--accent-hover); color: var(--accent); border-color: var(--accent); }
        #relationship-tags { display: flex; flex-wrap: wrap; gap: 8px; min-height: 10px; }
        .rel-tag { background: rgba(100, 181, 246, 0.08); color: #a0aab5; font-size: 0.75rem; padding: 4px 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 5px; font-family: var(--font-ui); }
        .rel-tag:hover { background: var(--accent-hover); color: var(--accent); border-color: var(--accent); transform: translateY(-1px); }
        .rel-tag span { color: var(--accent); font-weight: 500; }
        #editor { flex: 1; width: 100%; max-width: 720px; margin: 0 auto; background: transparent; border: none; resize: none; font-family: var(--font-editor); font-size: 1.15rem; line-height: 1.8; color: #dcdcdc; letter-spacing: 0.01em; overflow-y: auto; min-height: 0; white-space: pre-wrap; text-rendering: optimizeLegibility; padding-bottom: 60vh; user-select: text; transition: max-width 0.4s ease; }
        #editor:empty:before { content: 'Chapter 1...'; color: var(--text-muted); opacity: 0.3; font-style: italic; font-family: var(--font-ui); }
        .doc-link { color: var(--accent); text-decoration: none; border-bottom: 1px dotted var(--accent); cursor: pointer; transition: 0.2s; }
        .doc-link:hover { background: var(--accent-hover); color: #fff; }

        /* Status Bar */
        .status-bar { position: absolute; bottom: 30px; right: 40px; display: flex; align-items: center; gap: 20px; pointer-events: none; z-index: 10; }
        #status-msg { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; opacity: 0.5; }
        #status-stats { font-size: 1.1rem; font-weight: 500; color: var(--accent); background: rgba(19, 23, 32, 0.85); border: 1px solid rgba(100, 181, 246, 0.3); padding: 10px 18px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px); font-family: var(--font-ui); min-width: 120px; text-align: center; transition: all 0.3s ease; }
        .zen-mode #status-stats { opacity: 0.7; border-color: transparent; background: transparent; box-shadow: none; }

        /* Overlays (Graph, Context Menu, Modal) */
        #graph-view { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #050608; z-index: 5000; display: none; opacity: 0; transition: opacity 0.3s; }
        #graph-view.active { display: block; opacity: 1; }
        #graph-canvas { display: block; width: 100%; height: 100%; cursor: grab; }
        #graph-canvas:active { cursor: grabbing; }
        .graph-controls { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; }
        .btn-graph-close { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-family: var(--font-ui); }
        .btn-graph-close:hover { background: var(--danger); border-color: var(--danger); }
        
        #context-menu { position: absolute; background: #161b22; border: 1px solid var(--glass-border); border-radius: 8px; padding: 6px; display: none; z-index: 6000; min-width: 150px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .ctx-item { padding: 8px 12px; cursor: pointer; font-size: 0.85rem; color: var(--text-main); border-radius: 4px; transition: 0.1s;}
        .ctx-item:hover { background: var(--accent); color: #000; }
        .ctx-item.delete:hover { background: var(--danger); color: #fff; }
        .ctx-separator { height: 1px; background: var(--glass-border); margin: 4px 0; }
        
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 2000; display: none; justify-content: center; align-items: flex-start; padding-top: 10%; animation: fadeIn 0.2s ease-out; }
        .modal-box { width: 400px; background: #131720; border: 1px solid var(--glass-border); border-radius: 12px; padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); display: flex; flex-direction: column; gap: 15px; transform: scale(0.95); animation: popIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 1; } to { transform: scale(1); opacity: 1; } }
        .modal-title { font-size: 1.1rem; font-weight: 600; color: var(--text-main); margin: 0; }
        .modal-msg { font-size: 0.9rem; color: #a0aab5; line-height: 1.5; }
        .modal-input { width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-main); font-size: 0.95rem; }
        .modal-input:focus { border-color: var(--accent); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: 0.2s; }
        .btn-cancel { background: transparent; color: var(--text-muted); border: 1px solid transparent; }
        .btn-cancel:hover { color: var(--text-main); border-color: var(--glass-border); }
        .btn-confirm { background: var(--accent); color: #000; }
        .btn-confirm:hover { background: #82c7ff; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-danger:hover { background: #ff6b6b; }
        .btn-small { padding: 4px 8px; font-size: 0.8rem; }
        
        .toast { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1e2530; border: 1px solid var(--glass-border); color: var(--text-main); padding: 10px 20px; border-radius: 30px; font-size: 0.9rem; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 3000; opacity: 0; pointer-events: none; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .toast.show { opacity: 1; bottom: 40px; }
        .toast.error i { color: var(--danger); }
        
        /* Novel Cover View Styles */
        #novel-cover-view { display: none; flex-direction: column; align-items: center; justify-content: flex-start; padding: 60px 40px; height: 100%; overflow-y: auto; text-align: center; max-width: 800px; margin: 0 auto; transition: opacity 0.3s ease; }
        #novel-cover-view.active { display: flex; }
        #novel-cover-view h1 { font-family: var(--font-editor); font-size: 3.5rem; font-weight: 700; color: var(--text-main); margin-bottom: 20px; letter-spacing: 0.02em; }
        #novel-cover-view h2 { font-family: var(--font-ui); font-size: 1.2rem; font-weight: 400; color: var(--text-muted); margin-bottom: 40px; }
        #novel-cover-view p.synopsis { font-family: var(--font-editor); font-size: 1.1rem; line-height: 1.8; color: #a0aab5; margin-bottom: 50px; max-width: 600px; }
        #novel-index { width: 100%; max-width: 500px; text-align: left; margin-bottom: 40px; border: 1px solid var(--glass-border); border-radius: 8px; padding: 20px; background: rgba(0,0,0,0.2); }
        #novel-index h3 { font-family: var(--font-ui); font-size: 1.1rem; color: var(--accent); margin-top: 0; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        #novel-index ul { list-style: none; padding: 0; margin: 0; }
        #novel-index li { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        #novel-index li:last-child { border-bottom: none; }
        #novel-index li a { color: #a0aab5; text-decoration: none; font-size: 0.95rem; display: block; transition: color 0.2s, background 0.2s; padding: 4px 8px; border-radius: 4px; }
        #novel-index li a:hover { color: var(--text-main); background: rgba(255,255,255,0.03); }
        #novel-index li a.active-chapter { color: var(--accent); font-weight: 500; background: var(--accent-hover); }
        .novel-actions, .chapter-navigation { display: flex; gap: 15px; margin-top: 20px; }
        .btn-read-mode { background: rgba(100, 181, 246, 0.15); border: 1px solid var(--accent); color: var(--accent); font-weight: 600; box-shadow: 0 0 10px rgba(100, 181, 246, 0.1); }
        .btn-read-mode:hover { background: var(--accent); color: var(--bg-bottom); box-shadow: 0 0 20px rgba(100, 181, 246, 0.4); transform: translateY(-2px); }

        /* Chapter Navigation */
        .chapter-navigation { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(19, 23, 32, 0.95); border: 1px solid rgba(100, 181, 246, 0.3); border-radius: 50px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px); z-index: 10; display: none; height: 44px; padding: 0 8px; align-items: center; justify-content: center; gap: 0; }
        .chapter-navigation.active { display: flex; }
        .chapter-navigation button, #current-chapter-title { height: 100%; display: flex; align-items: center; justify-content: center; text-transform: uppercase; font-family: var(--font-ui); letter-spacing: 1px; line-height: 1; }
        .chapter-navigation button { background: transparent; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.7rem; font-weight: 600; padding: 0 15px; gap: 8px; transition: color 0.2s; }
        .chapter-navigation button:hover:not(:disabled) { color: var(--accent); }
        .chapter-navigation button:disabled { opacity: 0.2; cursor: not-allowed; }
        #current-chapter-title { color: var(--text-main); font-weight: 700; font-size: 0.8rem; max-width: 350px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 15px; padding-top: 1px; }

        /* Helpers for tree */
        .toggle-arrow { width: 20px; height: 20px; margin-right: 6px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }
        .arrow-svg { width: 12px; height: 12px; }
        .arrow-path { fill: none; stroke: var(--text-muted); stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round; transition: d 0.25s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.2s ease; }
        .toggle-arrow:hover .arrow-path { stroke: var(--text-main); }
        .toggle-arrow.open .arrow-path { stroke: var(--accent); }
        #novel-cover-view.active ~ .editor-header, #novel-cover-view.active ~ #editor, #novel-cover-view.active ~ .status-bar { display: none; }
        #selection-marquee { position: absolute; border: 1px solid var(--accent); background: rgba(100, 181, 246, 0.2); display: none; z-index: 10; pointer-events: none; }
        
        /* Otros elementos del modal */
        .link-results { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; margin-top: 10px;}
        .link-result-item { padding: 10px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; color: #a0aab5; display: flex; align-items: center; gap: 10px; }
        .link-result-item:hover { background: var(--accent-hover); color: var(--accent); }
        .family-form { display: flex; gap: 10px; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; align-items: center; }
        .family-list { max-height: 150px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; margin-top: 5px; }
        .family-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02); padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; }
        .delete-list { list-style: none; padding: 0; margin: 10px 0; background: rgba(0, 0, 0, 0.2); border-radius: 8px; max-height: 150px; overflow-y: auto; border: 1px solid var(--glass-border); }
        .delete-list li { padding: 8px 12px; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; color: #a0aab5; border-bottom: 1px solid rgba(255, 255, 255, 0.03); }
        .delete-list li:last-child { border-bottom: none; }
        .delete-warning { color: var(--danger); font-size: 0.85rem; margin-top: 10px; font-weight: 500; text-align: right; }
        .project-list { list-style: none; padding: 0; margin: 0; }
        .project-item { padding: 10px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .project-item:hover { background: rgba(255,255,255,0.03); }
        .project-item.active { border-left: 3px solid var(--accent); background: rgba(100, 181, 246, 0.05); }
        .project-actions { display: flex; gap: 5px; }


        /* ==========================================================================
           READER MODE STYLES (INTEGRATED)
           ========================================================================== */
        #reader-view {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background-color: var(--reader-bg);
            background-image: radial-gradient(circle at center, #2a2a2a 0%, #111 100%);
            z-index: 10000; /* Highest layer */
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #reader-view.active {
            display: flex;
            opacity: 1;
        }

        .book-stage {
            width: 90vw; 
            height: 85vh; 
            max-width: 1400px;
            max-height: 800px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: auto;
        }

        /* Reader Page Styles */
        .page {
            background-color: var(--reader-page-bg);
            padding: 5vh 5vw;
            box-sizing: border-box;
            box-shadow: inset -3px 0 10px rgba(0,0,0,0.05);
            overflow: hidden;
            display: none; /* Managed by page-flip */
            border-radius: 3px; 
            color: var(--reader-text);
            font-family: 'Merriweather', serif;
        }

        /* Reader Cover */
        .page-cover {
            background-color: #1e2630;
            color: #f0f0f0;
            border: 1px solid rgba(255,255,255,0.1);
            background-image: linear-gradient(45deg, rgba(0,0,0,0.05) 25%, transparent 25%, transparent 50%, rgba(0,0,0,0.05) 50%, rgba(0,0,0,0.05) 75%, transparent 75%, transparent);
            background-size: 4px 4px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: inset 5px 0 20px rgba(0,0,0,0.3);
        }

        .page-cover h1 {
            font-family: 'Cinzel', serif;
            font-size: clamp(2rem, 5vw, 4rem); 
            color: var(--reader-accent);
            margin: 0 0 20px 0;
            line-height: 1.2;
            text-transform: uppercase;
            padding: 0 20px;
        }

        .page-cover h2 {
            font-family: 'Merriweather', sans-serif;
            font-size: clamp(1rem, 2vw, 1.5rem);
            font-weight: 300;
            letter-spacing: 2px;
            opacity: 0.9;
            margin: 0;
        }

        .cover-decoration {
            font-size: clamp(2rem, 4vw, 3rem);
            color: var(--reader-accent);
            margin: 40px 0;
            opacity: 0.7;
        }

        /* Reader Content */
        .page-content {
            font-size: clamp(0.95rem, 1.3vh, 1.2rem); 
            line-height: 1.8;
            text-align: justify;
        }

        .page-header {
            text-align: center;
            font-size: 0.75rem;
            color: #999;
            text-transform: uppercase;
            margin-bottom: 3vh;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .page-footer {
            position: absolute;
            bottom: 20px;
            width: calc(100% - 10vw);
            text-align: center;
            font-size: 0.9rem;
            font-weight: bold;
            color: #777;
            font-family: 'Cinzel', serif;
        }

        .chapter-title {
            font-family: 'Cinzel', serif;
            font-size: clamp(1.5rem, 3vw, 2.5rem);
            text-align: center;
            margin-top: 2vh;
            margin-bottom: 4vh;
            color: #000;
        }

        .page p { margin-bottom: 1.5em; text-indent: 1.5em; }
        .page p:first-of-type { text-indent: 0; }

        /* Reader ToC */
        .toc-list { list-style: none; padding: 0; }
        .toc-item {
            display: flex;
            justify-content: space-between;
            padding: 1vh 0;
            border-bottom: 1px dashed #ddd;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
        }
        .toc-item:hover { color: #b8860b; font-weight: bold; padding-left: 5px; }

        /* Reader Controls */
        .reader-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            z-index: 1000;
            background: rgba(20, 20, 20, 0.95);
            padding: 10px 30px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.15);
            transition: opacity 0.3s;
        }
        
        .reader-btn {
            background: transparent; border: none; color: #ccc;
            font-size: 1.2rem; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .reader-btn:hover { color: var(--reader-accent); transform: scale(1.1); }
        .reader-btn.close:hover { color: var(--danger); }

        .loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--reader-bg);
            display: flex; justify-content: center; align-items: center;
            color: #fff; font-family: sans-serif; z-index: 200;
            flex-direction: column; gap: 15px;
        }
    </style>
</head>
<body>

    <div class="app-container">
        <aside id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title" onclick="openProjectManager()">
                    <i class="fas fa-box"></i>
                    <span>WRIT3R <span class="project-name" id="current-project-name">/ Default</span></span>
                </div>
                <div class="controls">
                    <button class="btn-icon" onclick="promptCreateNovel()" title="New Novel"><i class="fas fa-book-medical"></i></button>
                    <button class="btn-icon" onclick="promptCreateFolder()" title="New Folder"><i class="fas fa-folder-plus"></i></button>
                    <button class="btn-icon" onclick="createFile()" title="New File"><i class="fas fa-file-medical"></i></button>
                    <button class="btn-icon" onclick="toggleGraphView()" title="Graph View"><i class="fas fa-project-diagram"></i></button>
                </div>
            </div>
            <div class="file-tree" id="fileTree"></div>
            <div id="selection-marquee"></div>
        </aside>

        <main>
            <button id="exit-zen-btn" onclick="toggleZenMode()" title="Exit Zen Mode"><i class="fas fa-compress-alt"></i></button>

            <!-- Novel Cover / Management View -->
            <div id="novel-cover-view">
                <h1 id="novel-cover-title"></h1>
                <h2 id="novel-cover-author"></h2>
                <p id="novel-cover-synopsis" class="synopsis"></p>
                <div id="novel-index">
                    <h3>Chapters</h3>
                    <ul id="novel-index-list"></ul>
                </div>
                <div class="novel-actions">
                    <button class="btn-family btn-read-mode" onclick="openReaderMode()"><i class="fas fa-book-reader"></i> Read Novel</button>
                    <button class="btn-family" onclick="addChapterToNovel()"><i class="fas fa-plus"></i> Add Chapter</button>
                    <button class="btn-family" onclick="editNovelMetadata()"><i class="fas fa-edit"></i> Edit Novel Info</button>
                </div>
            </div>

            <!-- Editor Header -->
            <div class="editor-header">
                <div class="header-top-row">
                    <input type="text" id="doc-title" placeholder="Untitled" oninput="updateCurrentFile()">
                    <div class="header-actions">
                        <button id="family-btn" class="btn-family" onclick="openFamilyModal()"><i class="fas fa-users"></i> Family</button>
                        <button class="btn-family" onclick="toggleZenMode()"><i class="fas fa-expand-alt"></i> Zen</button>
                    </div>
                </div>
                <div id="relationship-tags"></div>
            </div>

            <!-- Editor Content -->
            <div id="editor" contenteditable="true" oninput="updateCurrentFile()"></div>

            <!-- Bottom Bar -->
            <div class="status-bar">
                <span id="status-msg">Ready</span>
                <span class="stat-separator"></span>
                <span id="status-stats">0 words</span>
            </div>

            <!-- Chapter Navigation -->
            <div id="chapter-navigation" class="chapter-navigation">
                <button id="prev-chapter-btn" onclick="navigateToChapter('prev')"><i class="fas fa-chevron-left"></i> Previous</button>
                <span id="current-chapter-title" style="color:var(--text-main); font-weight:500;"></span>
                <button id="next-chapter-btn" onclick="navigateToChapter('next')">Next <i class="fas fa-chevron-right"></i></button>
            </div>

        </main>

        <!-- Modals -->
        <div id="app-modal" class="modal-overlay">
            <div class="modal-box">
                <h3 id="modal-title" class="modal-title">Title</h3>
                <p id="modal-msg" class="modal-msg" style="display:none"></p>
                <div id="modal-body"></div>
                <div class="modal-actions">
                    <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
                    <button id="modal-confirm-btn" class="btn btn-confirm">Confirm</button>
                </div>
            </div>
        </div>
        <div id="toast" class="toast"><i class="fas fa-info-circle"></i> <span>Message</span></div>
    </div>

    <!-- OVERLAYS -->
    
    <!-- Graph View -->
    <div id="graph-view">
        <div class="graph-controls">
            <button class="btn-graph-close" onclick="toggleGraphView()"><i class="fas fa-times"></i> Close</button>
        </div>
        <canvas id="graph-canvas"></canvas>
    </div>

    <!-- READER VIEW (SPA INTEGRATION) -->
    <div id="reader-view">
        <div id="reader-loader" class="loader">
            <i class="fas fa-circle-notch fa-spin fa-2x" style="color:var(--reader-accent)"></i>
            <span>Printing Book...</span>
        </div>

        <div class="book-stage">
            <div id="book"></div>
        </div>

        <div class="reader-controls">
            <button class="reader-btn" onclick="bookInstance.flipPrev()"><i class="fas fa-arrow-left"></i></button>
            <button class="reader-btn close" onclick="closeReaderMode()"><i class="fas fa-times"></i> Close Book</button>
            <button class="reader-btn" onclick="bookInstance.flipNext()"><i class="fas fa-arrow-right"></i></button>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu">
        <div id="ctx-export-btn" class="ctx-item" onclick="exportItem()">
            <i class="fas fa-file-export" style="margin-right:8px"></i> Export (.doc)
        </div>
        <div class="ctx-separator" id="ctx-sep-1"></div>
        <div id="ctx-link-btn" class="ctx-item" onclick="openLinkSearch()" style="display:none; color: var(--accent);">
            <i class="fas fa-link" style="margin-right:8px"></i> Link File
        </div>
        <div id="ctx-unlink-btn" class="ctx-item delete" style="display:none">
            <i class="fas fa-unlink" style="margin-right:8px"></i> Remove Relationship
        </div>
        <div class="ctx-separator" id="ctx-sep-2" style="display:none;"></div>
        <div id="ctx-rename-btn" class="ctx-item" onclick="promptRename()"><i class="fas fa-edit" style="margin-right:8px"></i> Rename</div>
        <div id="ctx-delete-btn" class="ctx-item delete" onclick="promptDelete()"><i class="fas fa-trash" style="margin-right:8px"></i> Delete</div>
    </div>

    <script>
        // ======================== CORE APP LOGIC ========================
        let projects = JSON.parse(localStorage.getItem('writerApp_projects')) || ['Default Project'];
        let currentProject = localStorage.getItem('writerApp_currentProject') || 'Default Project';

        if (localStorage.getItem('writerApp_fs') && !localStorage.getItem('writerApp_fs_' + 'Default Project')) {
            localStorage.setItem('writerApp_fs_' + 'Default Project', localStorage.getItem('writerApp_fs'));
        }

        let fileSystem = JSON.parse(localStorage.getItem('writerApp_fs_' + currentProject)) || [];

        let currentFileId = null;
        let contextTargetId = null;
        let contextTargetProject = null;
        let savedRange = null;

        let selectedFileIds = new Set();
        let isSelecting = false;
        let selectionStart = { x: 0, y: 0 };
        let lastClickedId = null;
        let currentNovelId = null;

        // UI References
        const fileTreeEl = document.getElementById('fileTree');
        const sidebarEl = document.getElementById('sidebar');
        const marqueeEl = document.getElementById('selection-marquee');
        const titleInput = document.getElementById('doc-title');
        const editorDiv = document.getElementById('editor');
        const contextMenu = document.getElementById('context-menu');
        const statusMsg = document.getElementById('status-msg');
        const statusStats = document.getElementById('status-stats');
        const relTagsDiv = document.getElementById('relationship-tags');
        const projectNameEl = document.getElementById('current-project-name');

        const novelCoverView = document.getElementById('novel-cover-view');
        const novelCoverTitle = document.getElementById('novel-cover-title');
        const novelCoverAuthor = document.getElementById('novel-cover-author');
        const novelCoverSynopsis = document.getElementById('novel-cover-synopsis');
        const novelIndexList = document.getElementById('novel-index-list');
        const chapterNavigation = document.getElementById('chapter-navigation');
        const prevChapterBtn = document.getElementById('prev-chapter-btn');
        const nextChapterBtn = document.getElementById('next-chapter-btn');
        const currentChapterTitleEl = document.getElementById('current-chapter-title');

        // Graph References
        const graphView = document.getElementById('graph-view');
        const canvas = document.getElementById('graph-canvas');
        const ctx = canvas.getContext('2d');
        let animationId;
        let nodes = [];
        let links = [];
        let isDraggingNode = false;
        let draggedNode = null;
        let graphOffset = { x: 0, y: 0 };
        let graphScale = 1;
        let isPanning = false;
        let startPan = { x: 0, y: 0 };

        // Reader References
        let bookInstance = null;
        const readerView = document.getElementById('reader-view');
        const readerLoader = document.getElementById('reader-loader');
        const bookContainer = document.getElementById('book');

        // Initial Setup
        updateProjectUI();
        renderTree();

        const savedId = localStorage.getItem('writerApp_lastId_' + currentProject);

        document.querySelector('.editor-header').style.display = 'none';
        editorDiv.style.display = 'none';
        relTagsDiv.style.display = 'none';
        novelCoverView.classList.remove('active');
        chapterNavigation.classList.remove('active');

        if (fileSystem.length > 0) {
            const targetItem = fileSystem.find(f => f.id === savedId) || 
            fileSystem.find(f => f.type === 'novel') ||
            fileSystem.find(f => f.type === 'chapter') ||
            fileSystem.find(f => f.type === 'file');

            if(targetItem) {
                selectFile(targetItem.id);
            } else {
                statusMsg.innerText = 'Select a file';
            }
        } else {
            statusMsg.innerText = 'Create a file or a novel to start';
        }

        // ======================== READER LOGIC (SPA INTEGRATION) ========================
        
        function openReaderMode() {
            if (!currentNovelId) {
                showToast("No novel selected", true);
                return;
            }
            const hasChapters = fileSystem.some(f => f.parentId === currentNovelId && f.type === 'chapter');

            if (!hasChapters) {
                showToast("Add some chapters before reading!", true);
                return;
            }
            
            // Show Reader View
            readerView.style.display = 'flex';
            setTimeout(() => { readerView.classList.add('active'); }, 10);
            readerLoader.style.display = 'flex';
            bookContainer.innerHTML = ''; // Reset book

            // Initialize Book Construction
            setTimeout(() => {
                buildBook();
            }, 500);
        }

        function closeReaderMode() {
            readerView.classList.remove('active');
            setTimeout(() => {
                readerView.style.display = 'none';
                if(bookInstance) {
                    bookInstance.destroy();
                    bookInstance = null;
                }
                bookContainer.innerHTML = '';
            }, 500);
        }

        function buildBook() {
            // Get current novel data
            let novel = fileSystem.find(f => f.id === currentNovelId);
            if (!novel) return;

            // Get chapters
            let chapters = fileSystem.filter(f => f.type === 'chapter' && f.parentId === novel.id);
            chapters.sort((a, b) => (a.order || 0) - (b.order || 0));

            const CHARS_PER_PAGE = 1600; 
            let processedChapters = [];
            // Page offset: Cover(2) + Title(2) + ToC(2) = 6 start index
            let globalPageIndexCounter = 6; 

            chapters.forEach(chap => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = chap.content;
                let rawParagraphs = Array.from(tempDiv.querySelectorAll('p, div, h1, h2, h3, blockquote'));
                if(rawParagraphs.length === 0 && tempDiv.innerText.trim()) {
                    const p = document.createElement('p'); p.innerText = tempDiv.innerText; rawParagraphs = [p];
                }

                let pagesContent = [];
                let currentChunk = `<h2 class="chapter-title">${chap.name}</h2>`;
                let currentCount = 400;

                rawParagraphs.forEach(node => {
                    const text = node.innerText;
                    const weight = text.length; 
                    if (currentCount + weight > CHARS_PER_PAGE) {
                        pagesContent.push(currentChunk);
                        currentChunk = `<p>${text}</p>`;
                        currentCount = weight;
                    } else {
                        currentChunk += `<p>${text}</p>`;
                        currentCount += weight;
                    }
                });
                if(currentChunk) pagesContent.push(currentChunk);

                processedChapters.push({
                    title: chap.name,
                    contentChunks: pagesContent,
                    startIndex: globalPageIndexCounter 
                });

                globalPageIndexCounter += pagesContent.length;
            });

            // GENERATE HTML
            let html = '';

            // 1. PORTADA
            html += `
                <div class="page page-cover">
                    <div class="cover-decoration"><i class="fas fa-feather-alt"></i></div>
                    <h1>${novel.novelTitle || novel.name}</h1>
                    <div style="width: 60px; height: 3px; background: var(--reader-accent); margin: 30px auto;"></div>
                    <h2>${novel.author || 'Author'}</h2>
                </div>
                <div class="page page-cover"></div>
            `;

            // 2. TÍTULO
            html += `
                <div class="page page-content">
                    <div style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                        <h2 style="font-family:'Cinzel', serif; font-size: 2rem; margin-bottom:10px;">${novel.novelTitle || novel.name}</h2>
                        <p style="font-size: 1rem; color: #666;">A WRIT3R Production</p>
                    </div>
                </div>
                <div class="page page-content"></div>
            `;

            // 3. ÍNDICE
            let tocHTML = `<h2 class="chapter-title" style="margin-top:0;">Table of Contents</h2><ul class="toc-list">`;
            processedChapters.forEach((pChap, i) => {
                tocHTML += `<li class="toc-item" onclick="event.stopPropagation(); bookInstance.flip(${pChap.startIndex})">
                    <span>${i + 1}. ${pChap.title}</span>
                    <span>Page ${pChap.startIndex - 5}</span> 
                </li>`;
            });
            tocHTML += `</ul>`;
            
            html += `
                <div class="page page-content">${tocHTML}</div>
                <div class="page page-content"></div>
            `;

            // 4. CONTENIDO
            let globalPageNumber = 1; 

            processedChapters.forEach((pChap) => {
                pChap.contentChunks.forEach((content) => {
                    html += `
                        <div class="page page-content">
                            <div class="page-header">${novel.novelTitle || novel.name}</div>
                            <div style="flex:1; overflow:hidden;">${content}</div>
                            <div class="page-footer">${globalPageNumber++}</div>
                        </div>
                    `;
                });
            });

            // 5. FIN
            html += `
                <div class="page page-content"></div>
                <div class="page page-cover">
                    <div style="margin-top:auto; margin-bottom:auto;">
                        <i class="fas fa-book-open" style="font-size:4rem; color:var(--reader-accent); margin-bottom: 20px;"></i>
                        <p style="text-transform:uppercase; letter-spacing:3px;">The End</p>
                    </div>
                </div>
            `;

            bookContainer.innerHTML = html;

            // Initialize PageFlip
            const pageFlip = new St.PageFlip(document.getElementById('book'), {
                width: 600, 
                height: 900,
                size: 'stretch',
                minWidth: 300,
                maxWidth: 1000,
                minHeight: 400,
                maxHeight: 1400,
                maxShadowOpacity: 0.5,
                showCover: true,
                mobileScrollSupport: false,
                usePortrait: true 
            });

            pageFlip.loadFromHTML(document.querySelectorAll('.page'));

            setTimeout(() => {
                readerLoader.style.display = 'none';
                document.querySelectorAll('.page').forEach(p => p.style.display = 'block');
            }, 500);

            bookInstance = pageFlip;
        }

        // ======================== APP FUNCTIONS ========================

        function toggleZenMode() {
            const container = document.querySelector('.app-container');
            container.classList.toggle('zen-mode');
            if(container.classList.contains('zen-mode')) {
                showToast("Zen Mode Active");
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const container = document.querySelector('.app-container');
                if (container.classList.contains('zen-mode')) {
                    toggleZenMode();
                }
                // Also close reader if open
                if (readerView.classList.contains('active')) {
                    closeReaderMode();
                }
            }
        });

        function updateStats() {
            if (!currentFileId) {
                statusStats.innerText = "";
                return;
            }
            const text = editorDiv.innerText || "";
            const wordCount = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
            const time = Math.ceil(wordCount / 200);

            let timeStr = time + "m";
            if (time < 1 && wordCount > 0) timeStr = "<1m";
            if (wordCount === 0) timeStr = "0m";

            statusStats.innerText = `${wordCount} words • ${timeStr} read`;
        }

        function updateProjectUI() {
            projectNameEl.textContent = "/ " + currentProject;
        }

        function openProjectManager() {
            let html = `
<div style="display:flex; gap:10px; margin-bottom:15px;">
<input type="text" id="new-project-input" class="modal-input" placeholder="New Project Name">
<button class="btn btn-confirm" id="create-project-btn"><i class="fas fa-plus"></i></button>
</div>
<div style="max-height:200px; overflow-y:auto; border:1px solid rgba(255,255,255,0.1); border-radius:6px;">
<ul class="project-list" id="project-list-ul"></ul>
</div>
            `;

            openModal({
                title: 'Manage Projects',
                type: 'custom',
                customHTML: html
            });

            renderProjectList();

            document.getElementById('create-project-btn').onclick = () => {
                const name = document.getElementById('new-project-input').value.trim();
                if(name && !projects.includes(name)) {
                    projects.push(name);
                    localStorage.setItem('writerApp_projects', JSON.stringify(projects));
                    switchProject(name);
                    closeModal();
                } else if (projects.includes(name)) {
                    showToast("Project already exists", true);
                }
            };
        }

        function renderProjectList() {
            const ul = document.getElementById('project-list-ul');
            ul.innerHTML = '';
            projects.forEach(p => {
                const li = document.createElement('li');
                li.className = `project-item ${p === currentProject ? 'active' : ''}`;

                let deleteBtn = '';
                if (projects.length > 1) { 
                    deleteBtn = `<button class="btn btn-danger btn-small" onclick="promptProjectDelete('${p}', event)"><i class="fas fa-trash"></i></button>`;
                }

                li.innerHTML = `
<span style="flex:1" onclick="switchProject('${p}')">${p}</span>
<div class="project-actions">
                    ${deleteBtn}
</div>
                `;
                li.oncontextmenu = (e) => {
                    e.preventDefault();
                    showProjectContextMenu(e, p);
                }
                ul.appendChild(li);
            });
        }

        function switchProject(name) {
            if(name === currentProject) return;
            currentProject = name;
            localStorage.setItem('writerApp_currentProject', currentProject);

            fileSystem = JSON.parse(localStorage.getItem('writerApp_fs_' + currentProject)) || [];

            currentFileId = null;
            currentNovelId = null;
            titleInput.value = "";
            editorDiv.innerHTML = "";
            relTagsDiv.innerHTML = "";
            statusStats.innerText = "";
            selectedFileIds.clear();

            novelCoverView.classList.remove('active');
            chapterNavigation.classList.remove('active');
            document.querySelector('.editor-header').style.display = 'none';
            editorDiv.style.display = 'none';

            updateProjectUI();
            renderTree();

            const lastId = localStorage.getItem('writerApp_lastId_' + currentProject);
            if(lastId) {
                const f = fileSystem.find(x => x.id === lastId);
                if(f) selectFile(f.id);
            } else if (fileSystem.length > 0) {
                const f = fileSystem.find(x => x.type === 'novel') || fileSystem.find(x => x.type === 'file');
                if(f) selectFile(f.id);
            }

            closeModal();
            showToast(`Switched to ${name}`);
        }

        function showProjectContextMenu(e, projectName) {
            contextTargetProject = projectName;
            const menu = document.getElementById('context-menu');

            document.getElementById('ctx-export-btn').style.display = 'none';
            document.getElementById('ctx-link-btn').style.display = 'none';
            document.getElementById('ctx-sep-1').style.display = 'none';
            document.getElementById('ctx-sep-2').style.display = 'none';

            const renameBtn = document.getElementById('ctx-rename-btn');
            renameBtn.onclick = promptProjectRename;

            const deleteBtn = document.getElementById('ctx-delete-btn');
            if (projects.length > 1) {
                deleteBtn.style.display = 'block';
                deleteBtn.onclick = () => promptProjectDelete(projectName);
            } else {
                deleteBtn.style.display = 'none';
            }

            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        }

        function promptProjectRename() {
            const oldName = contextTargetProject;
            openModal({
                title: 'Rename Project',
                type: 'prompt',
                inputVal: oldName,
                onConfirm: (newName) => {
                    if(newName && newName !== oldName && !projects.includes(newName)) {
                        const idx = projects.indexOf(oldName);
                        projects[idx] = newName;
                        localStorage.setItem('writerApp_projects', JSON.stringify(projects));

                        const data = localStorage.getItem('writerApp_fs_' + oldName);
                        const lastId = localStorage.getItem('writerApp_lastId_' + oldName);

                        localStorage.setItem('writerApp_fs_' + newName, data);
                        if(lastId) localStorage.setItem('writerApp_lastId_' + newName, lastId);

                        localStorage.removeItem('writerApp_fs_' + oldName);
                        localStorage.removeItem('writerApp_lastId_' + oldName);

                        if(currentProject === oldName) {
                            currentProject = newName;
                            localStorage.setItem('writerApp_currentProject', currentProject);
                            updateProjectUI();
                        }

                        const listUl = document.getElementById('project-list-ul');
                        if(listUl) renderProjectList();

                        showToast("Project renamed");
                    }
                }
            });
        }

        window.promptProjectDelete = (name, e) => {
            if(e) e.stopPropagation();

            openModal({
                title: 'Delete Project?',
                message: `Are you sure you want to delete "${name}" and all its files?`,
                type: 'delete',
                onConfirm: () => {
                    projects = projects.filter(p => p !== name);
                    localStorage.setItem('writerApp_projects', JSON.stringify(projects));

                    localStorage.removeItem('writerApp_fs_' + name);
                    localStorage.removeItem('writerApp_lastId_' + name);

                    if(name === currentProject) {
                        switchProject(projects[0]);
                    } else {
                        const listUl = document.getElementById('project-list-ul');
                        if(listUl) renderProjectList();
                    }
                    showToast("Project deleted");
                }
            });
        }

        // Graph Functions
        function toggleGraphView() {
            if (graphView.classList.contains('active')) {
                graphView.classList.remove('active');
                cancelAnimationFrame(animationId);
            } else {
                graphView.classList.add('active');
                initGraph();
            }
        }

        function initGraph() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            nodes = [];
            links = [];
            const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();

            fileSystem.forEach(f => {
                if(f.type === 'file') {
                    nodes.push({
                        id: f.id,
                        name: f.name,
                        x: (Math.random() - 0.5) * (canvas.width * 0.5),
                        y: (Math.random() - 0.5) * (canvas.height * 0.5),
                        vx: 0, vy: 0,
                        radius: 5, 
                        connections: 0,
                        color: accentColor 
                    });
                }
            });

            fileSystem.forEach(f => {
                if (f.type !== 'file') return;

                if (f.relationships) {
                    f.relationships.forEach(r => { 
                        links.push({ source: f.id, target: r.targetId }); 
                        incrementConnections(f.id);
                        incrementConnections(r.targetId);
                    });
                }

                const regex = /data-id="([^"]+)"/g;
                let match;
                while ((match = regex.exec(f.content)) !== null) {
                    links.push({ source: f.id, target: match[1] });
                    incrementConnections(f.id);
                    incrementConnections(match[1]);
                }
            });

            nodes.forEach(n => {
                n.radius = 5 + (Math.log(n.connections + 1) * 6);
            });

            function incrementConnections(id) {
                const n = nodes.find(x => x.id === id);
                if(n) n.connections++;
            }

            graphOffset = { x: canvas.width/2, y: canvas.height/2 };
            animateGraph();
        }

        function animateGraph() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const repulsion = 8000;    
            const linkLength = 150;    
            const springK = 0.02;      
            const centerGravity = 0.0003; 
            const maxSpeed = 8;       

            for(let i=0; i<nodes.length; i++) {
                for(let j=i+1; j<nodes.length; j++) {
                    let dx = nodes[j].x - nodes[i].x;
                    let dy = nodes[j].y - nodes[i].y;
                    let distSq = dx*dx + dy*dy;
                    if(distSq < 1) distSq = 1; 
                    let force = repulsion / distSq;
                    let dist = Math.sqrt(distSq);
                    let fx = (dx/dist) * force;
                    let fy = (dy/dist) * force;
                    nodes[i].vx -= fx; nodes[i].vy -= fy;
                    nodes[j].vx += fx; nodes[j].vy += fy;
                }
            }

            links.forEach(l => {
                const s = nodes.find(n => n.id === l.source);
                const t = nodes.find(n => n.id === l.target);
                if(s && t) {
                    let dx = t.x - s.x;
                    let dy = t.y - s.y;
                    let dist = Math.sqrt(dx*dx + dy*dy) || 1;
                    let force = (dist - linkLength) * springK; 
                    let fx = (dx/dist) * force;
                    let fy = (dy/dist) * force;
                    s.vx += fx; s.vy += fy;
                    t.vx -= fx; t.vy -= fy;
                }
            });

            nodes.forEach(n => {
                n.vx -= n.x * centerGravity;
                n.vy -= n.y * centerGravity;
                n.vx *= 0.90; n.vy *= 0.90;
                let speed = Math.sqrt(n.vx*n.vx + n.vy*n.vy);
                if(speed > maxSpeed) {
                    n.vx = (n.vx/speed) * maxSpeed;
                    n.vy = (n.vy/speed) * maxSpeed;
                }
                if(!isDraggingNode || draggedNode !== n) { 
                    n.x += n.vx; n.y += n.vy; 
                }
            });

            ctx.save();
            ctx.translate(graphOffset.x, graphOffset.y);
            ctx.scale(graphScale, graphScale);
            ctx.lineWidth = 1.5;
            links.forEach(l => {
                const s = nodes.find(n => n.id === l.source);
                const t = nodes.find(n => n.id === l.target);
                if(s && t) { 
                    const grad = ctx.createLinearGradient(s.x, s.y, t.x, t.y);
                    grad.addColorStop(0, "rgba(100, 181, 246, 0.2)");
                    grad.addColorStop(1, "rgba(100, 181, 246, 0.6)");
                    ctx.strokeStyle = grad;
                    ctx.beginPath(); ctx.moveTo(s.x, s.y); ctx.lineTo(t.x, t.y); ctx.stroke(); 
                }
            });

            nodes.forEach(n => {
                ctx.shadowBlur = 10; ctx.shadowColor = n.color;
                ctx.fillStyle = n.color;
                ctx.beginPath(); ctx.arc(n.x, n.y, n.radius / graphScale, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0;
                ctx.fillStyle = '#c9d1d9'; 
                let fontSize = Math.max(8, 12 / graphScale); 
                ctx.font = `${fontSize}px var(--font-ui)`; 
                ctx.textAlign = 'center'; 
                ctx.fillText(n.name, n.x, n.y + (n.radius/graphScale) + 12);
            });

            ctx.restore();
            animationId = requestAnimationFrame(animateGraph);
        }

        canvas.addEventListener('mousedown', e => {
            const mouseX = (e.clientX - graphOffset.x) / graphScale;
            const mouseY = (e.clientY - graphOffset.y) / graphScale;
            if (e.button === 0) {
                let clickedNode = null;
                nodes.forEach(n => {
                    let dx = mouseX - n.x; let dy = mouseY - n.y;
                    if(dx*dx + dy*dy < (n.radius + 5)*(n.radius + 5)) { clickedNode = n; }
                });
                if(clickedNode) { isDraggingNode = true; draggedNode = clickedNode; } 
                else { isPanning = true; startPan = { x: e.clientX, y: e.clientY }; }
            }
        });

        canvas.addEventListener('mousemove', e => {
            if(isDraggingNode && draggedNode) {
                draggedNode.x = (e.clientX - graphOffset.x) / graphScale;
                draggedNode.y = (e.clientY - graphOffset.y) / graphScale;
                draggedNode.vx = 0; draggedNode.vy = 0; 
            } else if (isPanning) {
                let dx = e.clientX - startPan.x; let dy = e.clientY - startPan.y;
                graphOffset.x += dx; graphOffset.y += dy;
                startPan = { x: e.clientX, y: e.clientY };
            }
        });

        canvas.addEventListener('mouseup', e => { isDraggingNode = false; draggedNode = null; isPanning = false; });
        canvas.addEventListener('contextmenu', e => {
            e.preventDefault();
            const mouseX = (e.clientX - graphOffset.x) / graphScale;
            const mouseY = (e.clientY - graphOffset.y) / graphScale;
            let clickedNode = null;
            nodes.forEach(n => {
                let dx = mouseX - n.x; let dy = mouseY - n.y;
                if(dx*dx + dy*dy < (n.radius + 5)*(n.radius + 5)) { clickedNode = n; }
            });
            if(clickedNode) { toggleGraphView(); selectFile(clickedNode.id); }
        });
        canvas.addEventListener('wheel', e => {
            e.preventDefault();
            const zoomIntensity = 0.1;
            const wheel = e.deltaY < 0 ? 1 : -1;
            const zoom = Math.exp(wheel * zoomIntensity);
            graphScale *= zoom;
        });
        window.addEventListener('resize', () => {
            if(graphView.classList.contains('active')) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                graphOffset = { x: canvas.width/2, y: canvas.height/2 };
            }
        });

        // Modal Functions
        const modalEl = document.getElementById('app-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMsg = document.getElementById('modal-msg');
        const modalBody = document.getElementById('modal-body');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');

        function openModal({ title, message, type = 'confirm', inputVal = '', onConfirm, customHTML = '' }) {
            modalTitle.innerText = title;
            modalMsg.innerText = message || '';
            modalMsg.style.display = message ? 'block' : 'none';
            modalBody.innerHTML = ''; 
            let inputEl = null;

            if (customHTML) {
                modalBody.innerHTML = customHTML;
            }

            if (type === 'prompt') {
                inputEl = document.createElement('input');
                inputEl.type = 'text'; inputEl.className = 'modal-input'; inputEl.value = inputVal; inputEl.placeholder = 'Type here...';
                setTimeout(() => { inputEl.focus(); inputEl.select(); }, 100);
                inputEl.addEventListener('keydown', (e) => { if(e.key === 'Enter') modalConfirmBtn.click(); });
                modalBody.appendChild(inputEl);
            } else if (type === 'search') {
                inputEl = document.createElement('input'); inputEl.type = 'text'; inputEl.className = 'modal-input'; inputEl.placeholder = 'Search file...'; inputEl.id = 'modal-search-input';
                setTimeout(() => inputEl.focus(), 100);
                const resultsDiv = document.createElement('div'); resultsDiv.className = 'link-results'; resultsDiv.id = 'modal-search-results';
                modalBody.appendChild(inputEl); modalBody.appendChild(resultsDiv);
            }

            modalConfirmBtn.className = 'btn ' + (type === 'delete' ? 'btn-danger' : 'btn-confirm');
            modalConfirmBtn.innerText = type === 'delete' ? 'Delete' : (type === 'search' ? 'Link' : (type === 'custom' ? 'Confirm' : 'Confirm'));

            modalConfirmBtn.onclick = () => {
                if (type === 'prompt') {
                    if(inputEl.value.trim() !== '') { onConfirm(inputEl.value.trim()); closeModal(); }
                } else if (type === 'confirm' || type === 'delete') {
                    onConfirm(); closeModal();
                } else if (type === 'custom') { 
                    if (onConfirm) onConfirm(); 
                    closeModal(); 
                }
            };

            modalEl.style.display = 'flex';
            return { inputEl };
        }

        function closeModal() { modalEl.style.display = 'none'; }
        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            toast.innerHTML = `<i class="fas ${isError ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i> <span>${msg}</span>`;
            if(isError) toast.classList.add('error'); else toast.classList.remove('error');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function saveData() {
            localStorage.setItem('writerApp_fs_' + currentProject, JSON.stringify(fileSystem));
            if(currentFileId) localStorage.setItem('writerApp_lastId_' + currentProject, currentFileId);
            statusMsg.textContent = 'Saved';
            setTimeout(() => { statusMsg.textContent = 'Ready'; }, 2000);
        }

        function generateId() { return Math.random().toString(36).substr(2, 9); }

        function renderTree() {
            fileTreeEl.innerHTML = '';
            if(fileSystem.length === 0) {
                fileTreeEl.innerHTML = '<div style="color:var(--text-muted); font-size:0.8rem; text-align:center; margin-top:20px; opacity:0.5;">Empty</div>';
                return;
            }
            const rootItems = fileSystem.filter(item => item.parentId === null);
            rootItems.forEach(item => fileTreeEl.appendChild(createTreeItemDOM(item)));
        }

        function createTreeItemDOM(item) {
        const container = document.createElement('div');
        const div = document.createElement('div');

        let classes = ['tree-item'];
        if (currentFileId === item.id) classes.push('active-file');
        if (selectedFileIds.has(item.id)) classes.push('selected');

        div.className = classes.join(' ');
        div.draggable = true;
        div.dataset.id = item.id;
        div.dataset.type = item.type;

        let iconClass;
        if (item.type === 'folder') {
            iconClass = 'fas fa-folder'; 
        } else if (item.type === 'novel') { 
            iconClass = 'fas fa-book';
        } else if (item.type === 'chapter') {
            iconClass = 'fas fa-file-lines';
        } else {
            iconClass = 'fas fa-file-alt';
        }

        let toggleHTML = '';
        if (item.type === 'folder' || item.type === 'novel') {
            toggleHTML = `
                <span class="toggle-arrow ${item.isOpen ? 'open' : ''}">
                    <svg viewBox="0 0 12 12" class="arrow-svg">
                        <path class="arrow-path"
                            d="${item.isOpen
                                ? 'M2 4 L6 8 L10 4'
                                : 'M4 2 L8 6 L4 10'}" />
                    </svg>
                </span>
            `;
        } else {
            toggleHTML = `<span class="toggle-spacer"></span>`;
        }

        div.innerHTML = `${toggleHTML} <i class="${iconClass}"></i> <span>${item.name}</span>`;

        const toggleBtn = div.querySelector('.toggle-arrow');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFolder(item.id);
            });
        }

        div.addEventListener('click', (e) => {
            e.stopPropagation();
            if (e.target.closest('.toggle-arrow')) return;

            if (e.shiftKey && lastClickedId) {
                const allItems = Array.from(document.querySelectorAll('.tree-item'));
                const startIdx = allItems.findIndex(el => el.dataset.id === lastClickedId);
                const endIdx = allItems.findIndex(el => el.dataset.id === item.id);
                if (startIdx !== -1 && endIdx !== -1) {
                    const min = Math.min(startIdx, endIdx);
                    const max = Math.max(startIdx, endIdx);
                    if (!e.ctrlKey && !e.metaKey) selectedFileIds.clear();
                    for(let i = min; i <= max; i++) { selectedFileIds.add(allItems[i].dataset.id); }
                    renderTree(); return;
                }
            }
            
            if (e.ctrlKey || e.metaKey) {
                if (selectedFileIds.has(item.id)) { selectedFileIds.delete(item.id); } 
                else { selectedFileIds.add(item.id); }
                lastClickedId = item.id;
                renderTree(); return;
            }

            selectedFileIds.clear(); 
            selectedFileIds.add(item.id); 
            lastClickedId = item.id;

            selectFile(item.id); 
        });

        div.addEventListener('contextmenu', (e) => {
            e.preventDefault(); e.stopPropagation();
            if (!selectedFileIds.has(item.id)) { selectedFileIds.clear(); selectedFileIds.add(item.id); renderTree(); }
            document.getElementById('ctx-export-btn').style.display = 'block';
            document.getElementById('ctx-link-btn').style.display = 'none';
            document.getElementById('ctx-sep-1').style.display = 'block';
            document.getElementById('ctx-sep-2').style.display = 'none';
            document.getElementById('ctx-rename-btn').style.display = 'block'; 
            document.getElementById('ctx-rename-btn').onclick = promptRename;
            document.getElementById('ctx-delete-btn').onclick = promptDelete;
            document.getElementById('ctx-delete-btn').style.display = 'block';

            if (item.type === 'novel') {
                document.getElementById('ctx-export-btn').onclick = () => exportNovel(item.id);
                document.getElementById('ctx-export-btn').innerHTML = '<i class="fas fa-book-journal-whills" style="margin-right:8px"></i> Export Novel (.zip)';
            } else {
                document.getElementById('ctx-export-btn').onclick = exportItem;
                document.getElementById('ctx-export-btn').innerHTML = '<i class="fas fa-file-export" style="margin-right:8px"></i> Export (.doc)';
            }

            showContextMenu(e.pageX, e.pageY, item.id);
        });

        addDragEvents(div, item);
        container.appendChild(div);

        if ((item.type === 'folder' || item.type === 'novel') && item.isOpen) {
            const childrenContainer = document.createElement('div');
            childrenContainer.className = 'folder-content';
            const children = getSortedSiblings(item.id);
            children.forEach(child => childrenContainer.appendChild(createTreeItemDOM(child)));
            container.appendChild(childrenContainer);
        }
        return container;
    }

        function exportItem() {
            if (!contextTargetId) return;
            const item = fileSystem.find(f => f.id === contextTargetId);
            if (!item) return;
            showToast("Preparing download...", false);
            if (item.type === 'file') {
                downloadFile(item);
            } else {
                downloadFolder(item);
            }
        }

        function createDocContent(file) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = file.content;
            const links = tempDiv.querySelectorAll('a');
            links.forEach(link => {
                const text = document.createTextNode(link.innerText);
                link.parentNode.replaceChild(text, link);
            });
            const cleanContent = tempDiv.innerHTML;

            return `
<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
<head>
<meta charset="utf-8">
<title>${file.name}</title>
<style>
body { font-family: 'Merriweather', 'Times New Roman', serif; font-size: 12pt; line-height: 1.5; color: #000; }
h1 { font-size: 18pt; margin-bottom: 20px; }
</style>
</head>
<body>
<h1>${file.title}</h1>
${cleanContent}
</body>
</html>`;
            }

            function downloadFile(file) {
                const content = createDocContent(file);
                const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
                saveAs(blob, file.name + ".doc");
            }

            function downloadFolder(folder) {
                const zip = new JSZip();
                addFolderToZip(folder.id, zip.folder(folder.name));
                zip.generateAsync({type:"blob"}).then(function(content) {
                    saveAs(content, folder.name + ".zip");
                });
            }

            function exportNovel(novelId) {
        const novel = fileSystem.find(f => f.id === novelId);
        if (!novel || novel.type !== 'novel') return;

        showToast(`Preparing novel "${novel.name}" for download...`, false);

        const zip = new JSZip();
        const novelFolder = zip.folder(novel.name);

        novelFolder.file("Novel_Info.txt", `Title: ${novel.novelTitle || novel.name}\nAuthor: ${novel.author || 'N/A'}\n\nSynopsis:\n${novel.synopsis || 'N/A'}`);

        const siblings = getSortedSiblings(novel.id);
        const chapters = siblings.filter(f => f.type === 'chapter');

        chapters.forEach((chapter, index) => {
            const prefix = (index + 1).toString().padStart(2, '0');
            const content = createDocContent(chapter);
            novelFolder.file(`${prefix}_${chapter.name}.doc`, content);
        });

        zip.generateAsync({type:"blob"}).then(function(content) {
            saveAs(content, novel.name + "_Novel.zip");
        });
    }

            function addFolderToZip(parentId, currentZipFolder) {
                const children = fileSystem.filter(f => f.parentId === parentId);
                children.forEach(child => {
                    if (child.type === 'file') {
                        const content = createDocContent(child);
                        currentZipFolder.file(child.name + ".doc", content);
                    } else {
                        const newFolder = currentZipFolder.folder(child.name);
                        addFolderToZip(child.id, newFolder);
                    }
                });
            }

            sidebarEl.addEventListener('mousedown', (e) => {
                if (e.target.closest('.tree-item')) return; 
                if (e.target !== sidebarEl && e.target !== fileTreeEl) return;
                isSelecting = true;
                const sidebarRect = sidebarEl.getBoundingClientRect();
                selectionStart = { x: e.clientX - sidebarRect.left, y: e.clientY - sidebarRect.top + sidebarEl.scrollTop };
                if (!e.ctrlKey && !e.metaKey) selectedFileIds.clear();
                marqueeEl.style.left = selectionStart.x + 'px'; marqueeEl.style.top = selectionStart.y + 'px'; marqueeEl.style.width = '0px'; marqueeEl.style.height = '0px'; marqueeEl.style.display = 'block';
            });

            window.addEventListener('mousemove', (e) => {
                if (!isSelecting) return;
                const sidebarRect = sidebarEl.getBoundingClientRect();
                const currentX = e.clientX - sidebarRect.left;
                const currentY = e.clientY - sidebarRect.top + sidebarEl.scrollTop;
                const width = Math.abs(currentX - selectionStart.x);
                const height = Math.abs(currentY - selectionStart.y);
                const left = Math.min(currentX, selectionStart.x);
                const top = Math.min(currentY, selectionStart.y);
                marqueeEl.style.width = width + 'px'; marqueeEl.style.height = height + 'px'; marqueeEl.style.left = left + 'px'; marqueeEl.style.top = top + 'px';
                const items = document.querySelectorAll('.tree-item');
                const marqueeRect = marqueeEl.getBoundingClientRect();
                items.forEach(item => {
                    const itemRect = item.getBoundingClientRect();
                    if (rectsIntersect(marqueeRect, itemRect)) { selectedFileIds.add(item.dataset.id); item.classList.add('selected'); }
                });
            });

            window.addEventListener('mouseup', () => {
                if (isSelecting) { isSelecting = false; marqueeEl.style.display = 'none'; renderTree(); }
            });

            function rectsIntersect(r1, r2) { return !(r2.left > r1.right || r2.right < r1.left || r2.top > r1.bottom || r2.bottom < r1.top); }

            function addDragEvents(element, item) {
                element.addEventListener('dragstart', (e) => {
                    if (!selectedFileIds.has(item.id)) { selectedFileIds.clear(); selectedFileIds.add(item.id); document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('selected')); element.classList.add('selected'); }
                    e.dataTransfer.setData('text/plain', item.id);
                    element.classList.add('dragging');
                });
                element.addEventListener('dragend', () => {
                    element.classList.remove('dragging');
                    document.querySelectorAll('.drag-over, .drop-inside, .drop-top, .drop-bottom').forEach(el => { el.classList.remove('drag-over', 'drop-inside', 'drop-top', 'drop-bottom'); });
                });
                element.addEventListener('dragover', (e) => {
                    e.preventDefault(); e.stopPropagation();
                    element.classList.remove('drop-inside', 'drop-top', 'drop-bottom');
                    if (selectedFileIds.has(item.id)) return; 
                    const rect = element.getBoundingClientRect(); const relY = e.clientY - rect.top; const height = rect.height; const zoneSize = height * 0.25;
                    if (relY < zoneSize) element.classList.add('drop-top'); else if (relY > height - zoneSize) element.classList.add('drop-bottom'); else if (item.type === 'folder') element.classList.add('drop-inside'); else element.classList.add('drop-bottom'); 
                });
                element.addEventListener('dragleave', () => { element.classList.remove('drop-inside', 'drop-top', 'drop-bottom'); });
                element.addEventListener('drop', (e) => {
                    e.preventDefault(); e.stopPropagation();
                    let action = 'none';
                    if (element.classList.contains('drop-top')) action = 'before'; else if (element.classList.contains('drop-bottom')) action = 'after'; else if (element.classList.contains('drop-inside')) action = 'inside';
                    element.classList.remove('drop-inside', 'drop-top', 'drop-bottom');
                    if (action === 'none' || selectedFileIds.has(item.id)) return;
                    const idsToMove = Array.from(selectedFileIds);
                    for (let id of idsToMove) { if (isChildOf(item.id, id)) { showToast("Cannot move parent into child", true); return; } }
                        const itemsToMove = fileSystem.filter(f => selectedFileIds.has(f.id));
                    let newFileSystem = fileSystem.filter(f => !selectedFileIds.has(f.id));
                    const targetIndex = newFileSystem.findIndex(f => f.id === item.id);
                    if (targetIndex === -1 && action !== 'inside') return; 
                    if (action === 'inside') { itemsToMove.forEach(f => f.parentId = item.id); newFileSystem.push(...itemsToMove); item.isOpen = true; } 
                    else {
                        itemsToMove.forEach(f => f.parentId = item.parentId);
                        if (action === 'before') { newFileSystem.splice(targetIndex, 0, ...itemsToMove); } else { newFileSystem.splice(targetIndex + 1, 0, ...itemsToMove); }
                    }
                    fileSystem = newFileSystem; saveData(); renderTree();
                });
            }

            fileTreeEl.addEventListener('dragover', (e) => e.preventDefault());
            fileTreeEl.addEventListener('drop', (e) => {
                if(e.target === fileTreeEl) {
                    e.preventDefault();
                    const itemsToMove = fileSystem.filter(f => selectedFileIds.has(f.id));
                    let newFileSystem = fileSystem.filter(f => !selectedFileIds.has(f.id));
                    itemsToMove.forEach(f => f.parentId = null);
                    newFileSystem.push(...itemsToMove);
                    fileSystem = newFileSystem;
                    saveData(); renderTree();
                }
            });

            function currentDragId() { return document.querySelector('.dragging')?.dataset.id; }
            function isChildOf(parentId, possibleParentId) {
                let current = fileSystem.find(f => f.id === parentId);
                while(current && current.parentId) { if(current.parentId === possibleParentId) return true; current = fileSystem.find(f => f.id === current.parentId); }
                return false;
            }

            function promptCreateFolder() { 
        openModal({ 
            title: 'New Folder', 
            type: 'prompt', 
            onConfirm: (name) => { 
                const rootItems = fileSystem.filter(f => f.parentId === null);
                const maxOrder = rootItems.reduce((max, f) => Math.max(max, f.order || 0), 0);
                
                fileSystem.push({ 
                    id: generateId(), 
                    type: 'folder', 
                    name: name, 
                    parentId: null, 
                    isOpen: true,
                    order: maxOrder + 1 
                }); 
                saveData(); 
                renderTree(); 
            }
        }); 
    }

    function createFile() {
        let parentId = null;
        if(currentFileId) { 
            const current = fileSystem.find(f => f.id === currentFileId); 
            if(current && current.parentId) parentId = current.parentId; 
            if(current && current.type === 'folder') parentId = current.id; 
        }

        const siblings = fileSystem.filter(f => f.parentId === parentId);
        const maxOrder = siblings.reduce((max, f) => Math.max(max, f.order || 0), 0);

        const newFile = { 
            id: generateId(), 
            type: 'file', 
            name: 'New Story', 
            title: '', 
            content: '', 
            parentId: parentId, 
            relationships: [], 
            manuallyRenamed: false,
            order: maxOrder + 1
        };
        fileSystem.push(newFile); 
        saveData(); 
        renderTree(); 
        selectFile(newFile.id);
    }

    function getSortedSiblings(parentId) {
        const siblings = fileSystem.filter(f => f.parentId === parentId);
        return siblings.sort((a, b) => (a.order || 0) - (b.order || 0));
    }

            function toggleFolder(id) { const folder = fileSystem.find(f => f.id === id); if (folder) { folder.isOpen = !folder.isOpen; saveData(); renderTree(); } }

            function selectFile(id, scrollToChapter = false) {
                currentFileId = id; 
                const file = fileSystem.find(f => f.id === id);

                const familyBtn = document.getElementById('family-btn');

                document.querySelector('.editor-header').style.display = 'none';
                editorDiv.style.display = 'none';
                relTagsDiv.style.display = 'none';
                chapterNavigation.classList.remove('active');
                novelCoverView.classList.remove('active'); 

                titleInput.value = ""; 
                editorDiv.innerHTML = ""; 
                document.title = "WRIT3R"; 
                titleInput.placeholder = ""; 
                relTagsDiv.innerHTML = ""; 
                statusStats.innerText = ""; 

                if (file) { 
                    if (file.type === 'novel') {
                        currentNovelId = file.id;
                        novelCoverView.classList.add('active');
                        novelCoverTitle.innerText = file.novelTitle || file.name;
                        novelCoverAuthor.innerText = file.author ? `By ${file.author}` : '';
                        novelCoverSynopsis.innerText = file.synopsis || 'No synopsis provided yet. Click "Edit Novel Info" to add one.';
                        renderNovelIndex(file.id);
                    } else { 
                        currentNovelId = file.parentId && fileSystem.find(f => f.id === file.parentId)?.type === 'novel' ? file.parentId : null;

                        document.querySelector('.editor-header').style.display = 'flex';
                        editorDiv.style.display = 'block';
                        relTagsDiv.style.display = 'flex';

                        titleInput.value = file.title || ''; 
                        editorDiv.innerHTML = file.content || ''; 
                        document.title = file.name || "WRIT3R"; 
                        titleInput.placeholder = "Untitled"; 
                        renderRelationships(file);
                        updateStats(); 

                        if (file.type === 'chapter') {
                            chapterNavigation.classList.add('active');
                            updateChapterNavigation(file.id);
                            if(familyBtn) familyBtn.style.display = 'none'; 
                        } else {
                            if(familyBtn) familyBtn.style.display = 'flex';
                        }
                    }
                }
                renderTree();
                if (scrollToChapter) {
                    const element = document.querySelector(`.tree-item[data-id="${id}"]`);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }

            function updateCurrentFile() {
                if (!currentFileId) return; 
                const file = fileSystem.find(f => f.id === currentFileId);
                if (file) {
                    const newTitle = titleInput.value.trim(); 

                    file.title = newTitle; 
                    file.content = editorDiv.innerHTML; 

                    if (!file.manuallyRenamed && newTitle) {
                        file.name = newTitle;
                    } else if (!newTitle && !file.manuallyRenamed) {
                        file.name = (file.type === 'chapter' ? 'New Chapter' : 'Untitled');
                    }

                    saveData(); 
                    updateStats();
                    statusMsg.textContent = 'Typing...';

                    if (file.type === 'chapter' && currentNovelId) {
                        renderNovelIndex(currentNovelId);
                    }
                }
                renderTree();
            }

            function renderRelationships(file) {
                relTagsDiv.innerHTML = ''; 
                if(!file.relationships) return;

                file.relationships.forEach((rel, index) => {
                    const target = fileSystem.find(f => f.id === rel.targetId);
                    if(target) { 
                        const tag = document.createElement('div'); 
                        tag.className = 'rel-tag'; 
                        tag.innerHTML = `<span>${rel.type}</span> of ${target.name} <i class="fas fa-external-link-alt"></i>`; 
                        tag.onclick = () => selectFile(target.id); 
                        tag.oncontextmenu = (e) => {
                            e.preventDefault(); e.stopPropagation();
                            const menu = document.getElementById('context-menu');
                            const unlinkBtn = document.getElementById('ctx-unlink-btn');
                            document.getElementById('ctx-export-btn').style.display = 'none';
                            document.getElementById('ctx-link-btn').style.display = 'none';
                            document.getElementById('ctx-rename-btn').style.display = 'none';
                            document.getElementById('ctx-delete-btn').style.display = 'none';
                            document.getElementById('ctx-sep-1').style.display = 'none';
                            document.getElementById('ctx-sep-2').style.display = 'none';
                            unlinkBtn.style.display = 'block';
                            unlinkBtn.onclick = () => {
                                file.relationships.splice(index, 1); 
                                saveData(); renderRelationships(file); 
                                showToast("Relationship removed");
                                menu.style.display = 'none';
                            };
                            menu.style.display = 'block';
                            let x = e.pageX; let y = e.pageY;
                            if (y + menu.offsetHeight > window.innerHeight) y -= menu.offsetHeight;
                            if (x + menu.offsetWidth > window.innerWidth) x -= menu.offsetWidth;
                            menu.style.left = x + 'px'; menu.style.top = y + 'px';
                        };
                        relTagsDiv.appendChild(tag); 
                    }
                });
            }

            function promptCreateNovel() {
                openModal({
                    title: 'New Novel',
                    type: 'custom',
                    customHTML: `
<input type="text" id="novel-name-input" class="modal-input" placeholder="Novel Title" style="margin-bottom:10px;">
<input type="text" id="novel-author-input" class="modal-input" placeholder="Author Name (optional)" style="margin-bottom:10px;">
<textarea id="novel-synopsis-input" class="modal-input" placeholder="Brief Synopsis (optional)" rows="5"></textarea>
                        `,
                        onConfirm: () => {
                            const name = document.getElementById('novel-name-input').value.trim();
                            const author = document.getElementById('novel-author-input').value.trim();
                            const synopsis = document.getElementById('novel-synopsis-input').value.trim();
                            if (!name) { showToast("Novel title cannot be empty", true); return; }
                            const newNovel = {
                                id: generateId(),
                                type: 'novel',
                                name: name,
                                novelTitle: name,
                                author: author,
                                synopsis: synopsis,
                                parentId: null,
                                isOpen: true
                            };
                            fileSystem.push(newNovel); saveData(); renderTree(); selectFile(newNovel.id);
                        }
                    });
                document.getElementById('novel-name-input').addEventListener('keydown', (e) => { if(e.key === 'Enter') document.getElementById('modal-confirm-btn').click(); });
                setTimeout(() => document.getElementById('novel-name-input').focus(), 100);
            }

            function renderNovelIndex(novelId) {
        novelIndexList.innerHTML = '';
        const chapters = fileSystem.filter(f => f.parentId === novelId && f.type === 'chapter');
        chapters.sort((a, b) => (a.order || 0) - (b.order || 0));

        if (chapters.length === 0) {
            novelIndexList.innerHTML = '<li style="color:var(--text-muted); font-style:italic; font-size:0.85rem; padding:8px 0;">No chapters yet.</li>';
            return;
        }

        chapters.forEach((chapter, index) => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#';
            a.dataset.id = chapter.id;
            a.innerText = `${index + 1}. ${chapter.name}`;
            a.onclick = (e) => {
                e.preventDefault();
                selectFile(chapter.id, true); 
            };
            if (currentFileId === chapter.id) {
                a.classList.add('active-chapter');
            }
            li.appendChild(a);
            novelIndexList.appendChild(li);
        });
    }

            function addChapterToNovel() {
        if (!currentNovelId) {
            showToast("No novel selected", true);
            return;
        }
        const novel = fileSystem.find(f => f.id === currentNovelId);
        if (!novel || novel.type !== 'novel') return;

        const siblings = fileSystem.filter(f => f.parentId === currentNovelId);
        const maxOrder = siblings.reduce((max, f) => Math.max(max, f.order || 0), 0);
        
        const existingChaptersCount = siblings.filter(f => f.type === 'chapter').length;

        const newChapter = {
            id: generateId(),
            type: 'chapter',
            name: `Chapter ${existingChaptersCount + 1}`,
            title: `Chapter ${existingChaptersCount + 1}`,
            content: '',
            parentId: currentNovelId,
            relationships: [],
            manuallyRenamed: false,
            order: maxOrder + 1 
        };
        
        fileSystem.push(newChapter);
        saveData();
        renderTree();
        selectFile(newChapter.id);
    }

            function editNovelMetadata() {
                if (!currentNovelId) { showToast("No novel selected", true); return; }
                const novel = fileSystem.find(f => f.id === currentNovelId);
                if (!novel || novel.type !== 'novel') return;
                openModal({
                    title: 'Edit Novel Info',
                    type: 'custom',
                    customHTML: `
<input type="text" id="edit-novel-name-input" class="modal-input" placeholder="Novel Title" value="${novel.novelTitle || ''}" style="margin-bottom:10px;">
<input type="text" id="edit-novel-author-input" class="modal-input" placeholder="Author Name (optional)" value="${novel.author || ''}" style="margin-bottom:10px;">
<textarea id="edit-novel-synopsis-input" class="modal-input" placeholder="Brief Synopsis (optional)" rows="5">${novel.synopsis || ''}</textarea>
                        `,
                        onConfirm: () => {
                            const name = document.getElementById('edit-novel-name-input').value.trim();
                            const author = document.getElementById('edit-novel-author-input').value.trim();
                            const synopsis = document.getElementById('edit-novel-synopsis-input').value.trim();
                            if (!name) { showToast("Novel title cannot be empty", true); return; }
                            novel.name = name; novel.novelTitle = name;
                            novel.author = author; novel.synopsis = synopsis;
                            saveData(); renderTree(); selectFile(novel.id);
                        }
                    });
                document.getElementById('edit-novel-name-input').addEventListener('keydown', (e) => { if(e.key === 'Enter') document.getElementById('modal-confirm-btn').click(); });
                setTimeout(() => document.getElementById('edit-novel-name-input').focus(), 100);
            }

            function updateChapterNavigation(chapterId) {
        const chapter = fileSystem.find(f => f.id === chapterId);
        if (!chapter || chapter.type !== 'chapter') { chapterNavigation.classList.remove('active'); return; }
        
        const siblings = getSortedSiblings(chapter.parentId);
        const novelChapters = siblings.filter(f => f.type === 'chapter');

        const currentIndex = novelChapters.findIndex(c => c.id === chapterId);
        
        currentChapterTitleEl.innerText = `${currentIndex + 1}. ${chapter.name}`;
        
        prevChapterBtn.disabled = currentIndex <= 0;
        nextChapterBtn.disabled = currentIndex >= novelChapters.length - 1;
    }

            function navigateToChapter(direction) {
        if (!currentFileId) return;
        const currentChapter = fileSystem.find(f => f.id === currentFileId);
        if (!currentChapter || currentChapter.type !== 'chapter') return;
        
        const siblings = getSortedSiblings(currentChapter.parentId);
        const novelChapters = siblings.filter(f => f.type === 'chapter');
        
        const currentIndex = novelChapters.findIndex(c => c.id === currentChapter.id);
        let targetIndex;
        if (direction === 'prev') { targetIndex = currentIndex - 1; } 
        else { targetIndex = currentIndex + 1; }
        if (targetIndex >= 0 && targetIndex < novelChapters.length) { selectFile(novelChapters[targetIndex].id, true); }
    }

            function openFamilyModal() {
                if(!currentFileId) { showToast("Select a file first", true); return; }
                const file = fileSystem.find(f => f.id === currentFileId); 
                if(!file) return; 
                if(!file.relationships) file.relationships = [];
                const html = `
<div class="family-form">
<input type="text" id="rel-type-input" class="modal-input" placeholder="Role (e.g. Father)" style="flex:0.8">
<div style="flex:1.2; position:relative;">
<input type="text" id="rel-target-input" class="modal-input" placeholder="Search Character..." autocomplete="off" style="width:100%">
<div id="rel-search-results" class="link-results" style="position:absolute; top:100%; left:0; right:0; background:#131720; border:1px solid var(--glass-border); z-index:100; display:none; max-height:150px; border-radius:0 0 8px 8px; box-shadow:0 10px 20px rgba(0,0,0,0.5);"></div>
</div>
<button class="btn btn-confirm btn-small" id="add-rel-btn"><i class="fas fa-plus"></i></button>
</div>
<div class="family-list" id="family-list-container"></div>
                `;
                openModal({ title: 'Manage Relationships', type: 'custom', customHTML: html });
                const addBtn = document.getElementById('add-rel-btn'); 
                const typeInput = document.getElementById('rel-type-input'); 
                const targetInput = document.getElementById('rel-target-input');
                const resultsBox = document.getElementById('rel-search-results');
                const listContainer = document.getElementById('family-list-container');
                let selectedTargetId = null; 
                const refreshList = () => {
                    listContainer.innerHTML = '';
                    file.relationships.forEach((rel, index) => {
                        const target = fileSystem.find(f => f.id === rel.targetId); 
                        const name = target ? target.name : 'Unknown';
                        const item = document.createElement('div'); 
                        item.className = 'family-item';
                        item.innerHTML = `<div><strong>${rel.type}</strong> of ${name}</div><button class="btn btn-danger btn-small" onclick="removeRel(${index})"><i class="fas fa-times"></i></button>`;
                        listContainer.appendChild(item);
                    });
                };
                targetInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase(); selectedTargetId = null;
                    if(query.length < 1) { resultsBox.style.display = 'none'; return; }
                    const matches = fileSystem.filter(f => f.type === 'file' && f.id !== currentFileId && f.name.toLowerCase().includes(query));
                    resultsBox.innerHTML = '';
                    if(matches.length > 0) {
                        resultsBox.style.display = 'flex';
                        matches.forEach(match => {
                            const div = document.createElement('div');
                            div.className = 'link-result-item';
                            div.innerHTML = `<i class="fas fa-user"></i> ${match.name}`;
                            div.onclick = () => { targetInput.value = match.name; selectedTargetId = match.id; resultsBox.style.display = 'none'; };
                            resultsBox.appendChild(div);
                        });
                    } else { resultsBox.style.display = 'none'; }
                });
                document.addEventListener('click', (e) => { if(e.target !== targetInput && e.target !== resultsBox) { resultsBox.style.display = 'none'; }});
                window.removeRel = (index) => { file.relationships.splice(index, 1); saveData(); refreshList(); renderRelationships(file); };
                addBtn.onclick = () => {
                    const type = typeInput.value.trim();
                    const nameTyped = targetInput.value.trim();
                    if (!selectedTargetId && nameTyped) {
                        const exactMatch = fileSystem.find(f => f.type === 'file' && f.name.toLowerCase() === nameTyped.toLowerCase() && f.id !== currentFileId);
                        if (exactMatch) { selectedTargetId = exactMatch.id; }
                    }
                    if(!type || !selectedTargetId) { showToast("Character not found or Role empty", true); return; }
                    const exists = file.relationships.find(r => r.targetId === selectedTargetId && r.type === type);
                    if(exists) { showToast("Relationship already exists", true); return; }
                    file.relationships.push({ type: type, targetId: selectedTargetId }); 
                    saveData(); refreshList(); renderRelationships(file);
                    typeInput.value = ''; targetInput.value = ''; selectedTargetId = null;
                };
                refreshList();
            }

            function showContextMenu(x, y, id) { contextTargetId = id; contextMenu.style.display = 'block'; if (y + contextMenu.offsetHeight > window.innerHeight) y -= contextMenu.offsetHeight; if (x + contextMenu.offsetWidth > window.innerWidth) x -= contextMenu.offsetWidth; contextMenu.style.left = x + 'px'; contextMenu.style.top = y + 'px'; }
            document.addEventListener('click', () => contextMenu.style.display = 'none');

            function promptRename() {
                if(!contextTargetId) return;
                const item = fileSystem.find(f => f.id === contextTargetId);
                openModal({ 
                    title: 'Rename', 
                    type: 'prompt', 
                    inputVal: item.name, 
                    onConfirm: (newName) => { 
                        item.name = newName; 
                        item.manuallyRenamed = true; 
                        saveData(); renderTree(); 
                    }
                });
            }

            function promptDelete() {
                let idsToDelete = [];
                if (contextTargetId && !selectedFileIds.has(contextTargetId)) { idsToDelete = [contextTargetId]; } 
                else if (selectedFileIds.size > 0) { idsToDelete = Array.from(selectedFileIds); } 
                else { return; }

                const count = idsToDelete.length;
                const title = count > 1 ? `Delete ${count} Items?` : 'Delete Item?';

                let contentHTML = '<ul class="delete-list">';
                idsToDelete.forEach(id => {
                    const item = fileSystem.find(f => f.id === id);
                    if(item) {
                        let icon;
                        if (item.type === 'folder') icon = '<i class="fas fa-folder"></i>';
                        else if (item.type === 'novel') icon = '<i class="fas fa-book"></i>';
                        else if (item.type === 'chapter') icon = '<i class="fas fa-file-lines"></i>';
                        else icon = '<i class="fas fa-file-alt"></i>';
                        contentHTML += `<li>${icon} ${item.name}</li>`;
                    }
                });
                contentHTML += '</ul>';
                contentHTML += '<p class="delete-warning">This action cannot be undone.</p>';

                openModal({ title: title, type: 'delete', customHTML: contentHTML, onConfirm: () => {
                    let allIdsToDelete = new Set();
                    idsToDelete.forEach(id => { allIdsToDelete.add(id); if (fileSystem.find(f => f.id === id)?.type === 'folder' || fileSystem.find(f => f.id === id)?.type === 'novel') { findChildren(id); } });
                    function findChildren(pid) { fileSystem.filter(f => f.parentId === pid).forEach(child => { allIdsToDelete.add(child.id); if(child.type === 'folder' || child.type === 'novel') findChildren(child.id); }); }
                    fileSystem = fileSystem.filter(f => !allIdsToDelete.has(f.id));

                    if (currentFileId && allIdsToDelete.has(currentFileId)) {
                        currentFileId = null; currentNovelId = null;
                        titleInput.value = ""; editorDiv.innerHTML = ""; titleInput.placeholder = ""; relTagsDiv.innerHTML = ""; statusStats.innerText = ""; 
                        document.querySelector('.editor-header').style.display = 'none';
                        editorDiv.style.display = 'none';
                        relTagsDiv.style.display = 'none';
                        chapterNavigation.classList.remove('active');
                        novelCoverView.classList.remove('active');
                    } else if (currentNovelId && allIdsToDelete.has(currentNovelId)) {
                        currentNovelId = null;
                        document.querySelector('.editor-header').style.display = 'none';
                        editorDiv.style.display = 'none';
                        relTagsDiv.style.display = 'none';
                        chapterNavigation.classList.remove('active');
                        novelCoverView.classList.remove('active');
                    }
                    selectedFileIds.clear(); saveData(); renderTree(); showToast(count > 1 ? "Items deleted" : "Item deleted");
                }});
            }

            editorDiv.addEventListener('click', (e) => { if(e.target.classList.contains('doc-link')) { e.preventDefault(); selectFile(e.target.dataset.id); }});
            editorDiv.addEventListener('contextmenu', (e) => { const selection = window.getSelection(); if (selection.toString().length > 0) { e.preventDefault(); document.getElementById('ctx-export-btn').style.display = 'none'; document.getElementById('ctx-link-btn').style.display = 'block'; document.getElementById('ctx-sep-1').style.display = 'none'; document.getElementById('ctx-sep-2').style.display = 'block'; document.getElementById('ctx-rename-btn').style.display = 'none'; document.getElementById('ctx-delete-btn').style.display = 'none'; savedRange = selection.getRangeAt(0).cloneRange(); showContextMenu(e.pageX, e.pageY, null); }});

            function openLinkSearch() {
                contextMenu.style.display = 'none'; 
                if (!savedRange) return; 
                const text = savedRange.toString();
                const { inputEl } = openModal({ 
                    title: `Link "${text.substring(0,15)}${text.length>15?'...':''}" to:`, 
                    type: 'search', onConfirm: () => {} 
                });
                const resultsContainer = document.getElementById('modal-search-results');
                const insertLink = (id, label) => {
                    const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(savedRange); 
                    document.execCommand('insertHTML', false, `<a href="#" class="doc-link" data-id="${id}">${label}</a>`); 
                    updateCurrentFile(); closeModal(); savedRange = null;
                };
                const renderResults = (query) => {
                    resultsContainer.innerHTML = '';
                    if (query.trim().length > 0) {
                        const createDiv = document.createElement('div');
                        createDiv.className = 'link-result-item';
                        createDiv.style.color = 'var(--accent)';
                        createDiv.style.border = '1px dashed var(--glass-border)';
                        createDiv.innerHTML = `<i class="fas fa-plus-circle"></i> Create new: "<strong>${query}</strong>"`;
                        createDiv.onclick = () => {
                            const newId = generateId();
                            const newFile = { id: newId, type: 'file', name: query, title: query, content: '', parentId: null, relationships: [], manuallyRenamed: true };
                            fileSystem.push(newFile); saveData(); renderTree(); showToast(`Created "${query}"`);
                            insertLink(newId, text);
                        };
                        resultsContainer.appendChild(createDiv);
                    }
                    const matches = fileSystem.filter(f => f.type === 'file' && f.id !== currentFileId && f.name.toLowerCase().includes(query.toLowerCase()));
                    if(matches.length === 0 && query.trim().length === 0) { resultsContainer.innerHTML = '<div style="padding:10px; color:#606775; font-size:0.8rem;">Type to search or create...</div>'; return; }
                    matches.forEach(file => {
                        const div = document.createElement('div'); div.className = 'link-result-item'; 
                        div.innerHTML = `<i class="fas fa-file-alt"></i> ${file.name}`;
                        div.onclick = () => insertLink(file.id, savedRange.toString());
                        resultsContainer.appendChild(div);
                    });
                };
                renderResults(''); 
                inputEl.addEventListener('input', (e) => renderResults(e.target.value));
            }

            editorDiv.addEventListener('keydown', (e) => {
                const sel = window.getSelection();
                if (!sel.rangeCount) return;
                const node = sel.anchorNode;
                const parent = node.parentElement;
                if (e.key === '@') {
                    e.preventDefault(); 
                    document.execCommand('insertHTML', false, '<span class="pending-link">@</span>');
                    return;
                }
                if ((e.key === ' ' || e.key === 'Enter') && parent.classList.contains('pending-link')) {
                    e.preventDefault(); 
                    const rawText = parent.innerText;
                    const name = rawText.replace('@', '').trim();
                    if (name.length > 0) {
                        const targetId = getLinkIdForName(name);
                        const finalLink = document.createElement('a');
                        finalLink.href = "#"; finalLink.className = "doc-link"; finalLink.dataset.id = targetId; finalLink.textContent = name;
                        parent.replaceWith(finalLink);
                        const space = document.createTextNode('\u00A0');
                        finalLink.after(space);
                        const range = document.createRange();
                        range.setStartAfter(space); range.collapse(true);
                        sel.removeAllRanges(); sel.addRange(range);
                        updateCurrentFile();
                    } else {
                        const text = document.createTextNode('@ ');
                        parent.replaceWith(text);
                    }
                }
            });

            function getLinkIdForName(name) {
                const existing = fileSystem.find(f => (f.type === 'file' || f.type === 'chapter') && f.name.toLowerCase() === name.toLowerCase());
                if (existing) { return existing.id; } 
                else {
                    const newId = generateId();
                    const newFile = { id: newId, type: 'file', name: name, title: name, content: '', parentId: null, relationships: [], manuallyRenamed: true };
                    fileSystem.push(newFile); saveData(); renderTree(); showToast(`File "${name}" created`, false);
                    return newId;
                }
            }
    </script>
</body>
</html>
